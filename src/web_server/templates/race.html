{% set show_replay = raw_unlagged is defined %}
{% extends "base.html" %}
{% block head %}
<link rel="stylesheet" href="/static/css/race.css">

<!-- Open Graph / Discord Embed Meta Tags -->
<meta property="og:type" content="website">
<meta property="og:title" content="TypeRacer Race Details">
<meta property="og:description" content="Watch {{ username }} typing {{ wpm_adjusted|float|round|int }} WPM on TypeRacer&#10;&#10;&quot;{{ quote[:60] }}{% if quote|length > 60 %}...{% endif %}&quot;">
<meta property="og:image" content="https://typeracer.keegant.dev/assets/images/logo.png">
<meta name="theme-color" content="#1F51FF">
{% endblock %}

{% block title %}
<div>
    <div>Race Details</div>
    <div>
        {{ username }} - Race #{{ race_number_formatted }}
        {% if universe != "play" %} (Universe: {{ universe }}){% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="replay-body">
    <!-- RACE STATS CONTAINER -->
    <div class="container">
        <div class="info">
            <!-- Race Info table -->
            <table>
                <tr>
                    <td colspan="2" class="table-header">Race Info</td>
                </tr>
                <tr>
                    <td>Username</td>
                    <td>{{ username }}</td>
                </tr>
                <tr>
                    <td>Number</td>
                    <td>{{ race_number_formatted }}</td>
                </tr>
                <tr>
                    <td>Date</td>
                    <td>{{ date }}</td>
                </tr>
                <tr>
                    <td>Points</td>
                    <td>{{ points }}</td>
                </tr>
                <tr>
                    <td>Rank</td>
                    <td>{{ rank }}/{{ racers }}</td>
                </tr>
            </table>

            <!-- Speeds table -->
            <table>
                <tr>
                    <td colspan="2" class="table-header">Speeds</td>
                </tr>
                <tr>
                    <td>Speed</td>
                    <td>{{ wpm_unlagged }} WPM</td>
                </tr>
                <tr>
                    <td>Adjusted</td>
                    <td>{{ wpm_adjusted }} WPM</td>
                </tr>
                <tr>
                    <td>Accuracy</td>
                    <td>{{ accuracy }}</td>
                </tr>
                <tr>
                    <td>Start</td>
                    <td>{{ start_time }}s</td>
                </tr>
                <tr>
                    <td>Race Time</td>
                    <td>{{ total_time }}s</td>
                </tr>
            </table>

            <!-- Raw Speeds table -->
            <table>
                <tr>
                    <td colspan="2" class="table-header">Raw Speeds</td>
                </tr>
                <tr>
                    <td>Speed</td>
                    <td>
                        {% if show_replay %}
                        {{ raw_unlagged }} WPM
                        {% else %}
                        n/a
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Adjusted</td>
                    <td>
                        {% if show_replay %}
                        {{ raw_adjusted }} WPM
                        {% else %}
                        n/a
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Correction</td>
                    <td>
                        {% if show_replay %}
                        {{ correction_time }}s ({{ correction_percent }})
                        {% else %}
                        n/a
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Pauseless</td>
                    <td>
                        {% if show_replay %}
                        {{ pauseless_adjusted }} WPM
                        {% else %}
                        n/a
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Pause Time</td>
                    <td>
                        {% if show_replay %}
                        {{ pause_time }}s ({{ pause_percent }})
                        {% else %}
                        n/a
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- QUOTE INFO CONTAINER -->
    <div class="container">
        <table class="quote-table">
            <tr>
                <td class="table-header" style="text-align: left;">
                    <a href="https://www.typeracerdata.com/text?id={{ text_id }}" target="_blank">
                        Text - #{{ text_id }}
                    </a>
                    -
                    <a href="
                        {% if universe != 'play' %}
                            https://play.typeracer.com/?ghost={{ universe }}%7Cbot%3A1%7C{{ text_id }}&universe={{ universe }}
                        {% else %}
                            https://play.typeracer.com/?ghost=%7Cbot%3A1%7C{{ text_id }}
                        {% endif %}
                    " target="_blank">
                        Race This Text
                    </a>
                </td>
            </tr>
            <tr>
                <td class="quote-display" colspan="2">
                    <span style="user-select: none;">"</span><span>{{ quote }}</span><span
                        style="user-select: none;">"</span>
                </td>
            </tr>
            <tr>
                <td class="quote-info">
                    {{ quote.split()|length }} words - {{ quote|length }} characters
                </td>
            </tr>
        </table>
    </div>

    {% if show_replay %}
    <!-- REPLAY CONTAINER -->
    <div class="container">
        <div class="card" id="replayCard">
            <div style="font-weight: bold;">Replay</div>

            <!-- Clean replay text (with caret) -->
            <div class="text-box" id="replayText"></div>

            <!-- Stats row + Adjusted toggle -->
            <div class="stats-container">
                <div id="stats">
                    Time: 0.000s | WPM: 0.00 | Raw: 0.00 |
                </div>
                <div class="replay-settings">
                    <label>
                        <input type="checkbox" id="adjustedToggle" style="margin: 0;">
                        <span style="user-select: none;">Adjusted</span>
                    </label>
                </div>
            </div>

            <!-- Replay controls row -->
            <div class="replay-controls">
                <button id="playPauseButton">▶</button>
                <select id="speedSelect">
                    <option value="0.25">0.25x</option>
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="2">2x</option>
                </select>
                <button id="skipStart">|◀◀</button>
                <button id="rewind">◀◀</button>
                <button id="forward">▶▶</button>
                <button id="skipEnd">▶▶|</button>
            </div>

            <!-- Raw replay text (edits view) -->
            <div class="text-box" id="rawReplayText" style="user-select: none;"></div>

            <!-- Raw replay step controls -->
            <div class="replay-controls">
                <button id="rawRewind">|◀</button>
                <button id="rawForward">▶|</button>
            </div>
        </div>
    </div>

    <!-- MISTAKES + SPEED GRAPH CONTAINER -->
    <div class="container">
        <div class="card" id="mistakesCard">
            <div class="mistakes-graph-container">
                <!-- Left side: Mistakes list -->
                <div class="mistakes-section">
                    <div style="font-weight: bold; margin-bottom: 10px;">Mistakes</div>
                    <ul id="mistakesList"
                        style="
                            list-style: none;
                            padding: 0;
                            font-family: monospace;
                            font-size: 0.9rem;
                            color: #aaa;
                        ">
                    </ul>
                </div>

                <!-- Right side: Speed graph -->
                <div class="graph-section">
                    <div class="graph-title">Speed Throughout the Race</div>
                    <div id="speedGraph"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- TYPING LOG CONTAINER -->
    <div class="container">
        <div class="card typing-log-card">
            <div class="typing-log-header">
                <div style="font-weight: bold;">Typing Log</div>
                <span class="typing-log-toggle" id="toggleLog">show</span>
            </div>
            <div class="typing-log-content" id="typingLogContent">
                <button id="copyLogButton" class="copy-log-button" title="Copy log"></button>
                <pre id="typingLog" class="typing-log-data">{{ typing_log }}</pre>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if show_replay %}
<script>
    const quote = {{ quote | tojson }}
    const delays = {{ delays | tojson }}
    const rawDelays = {{ raw_delays | tojson }}
    const actionList = {{ processed_actions | tojson }}
    const graphData = {{ graph | tojson }}
</script>
<script src="/static/js/replay.js"></script>
{% endif %}

{% endblock %}
